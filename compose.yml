services:
  imgproxy:
    image: ghcr.io/imgproxy/imgproxy:latest
    environment:
      # Basic config
      IMGPROXY_BIND: '0.0.0.0:8080'
      IMGPROXY_LOCAL_FILESYSTEM_ROOT: /var/lib/imgproxy
      IMGPROXY_USE_ETAG: 'true'
      IMGPROXY_TTL: 3600

      # Security - generate these with: openssl rand -hex 64
      IMGPROXY_KEY: '${IMGPROXY_KEY}'
      IMGPROXY_SALT: '${IMGPROXY_SALT}'
      IMGPROXY_SIGNATURE_SIZE: 32

      # Format settings
      IMGPROXY_AUTO_WEBP: 'true'
      IMGPROXY_ENFORCE_WEBP: 'true'
      IMGPROXY_AUTO_AVIF: 'true'
      IMGPROXY_AVIF_SPEED: 8 # Faster AVIF encoding

      # TIMEOUT SETTINGS - key for large images
      IMGPROXY_TIMEOUT: 60
      IMGPROXY_READ_REQUEST_TIMEOUT: 60
      IMGPROXY_DOWNLOAD_TIMEOUT: 60
      IMGPROXY_KEEP_ALIVE_TIMEOUT: 10

      # Processing optimization
      IMGPROXY_STRIP_METADATA: 'true' # Remove metadata for smaller files
      IMGPROXY_STRIP_COLOR_PROFILE: 'true' # Remove color profile
      IMGPROXY_RETURN_ATTACHMENT: 'false' # Faster delivery

      # Limits for large D&D maps
      IMGPROXY_MAX_SRC_FILE_SIZE: 52428800 # 50MB
      IMGPROXY_MAX_SRC_DIMENSION: 16000 # 16000px (was 8000px)
      IMGPROXY_MAX_SRC_RESOLUTION: 268435456 # 268MP (16384x16384)
      IMGPROXY_MAX_ANIMATION_FRAMES: 1 # Static maps only

      # Performance
      IMGPROXY_WORKERS: 1
      IMGPROXY_MAX_CLIENTS: 50
      IMGPROXY_PRESETS: 'thumbnail=resize:fit:300:300:0:0/quality:70,small=resize:fit:800:800:0:0/quality:80,medium=resize:fit:1280:1280:0:0/quality:85,large=resize:fit:1920:1920:0:0/quality:90'

      # Caching
      IMGPROXY_CACHE_CONTROL_PASSTHROUGH: 'true'
      IMGPROXY_SET_CANONICAL_HEADER: 'true'

      # Dev
      IMGPROXY_IGNORE_SSL_VERIFICATION: true
      IMGPROXY_DEVELOPMENT_ERRORS_MODE: true

    volumes:
      - ./uploads:/var/lib/imgproxy:ro # Read-only access to uploads
      - ./imgproxy-cache:/tmp/imgproxy
    ports:
      - '8080:8080'
    restart: unless-stopped
